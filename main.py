# -*- coding: utf-8 -*-

# --- ุงูููุชุจุงุช ุงููุทููุจุฉ ---
import os
import sqlite3
import logging
import asyncio
import psycopg2 # [ุชู ุงูุชุทููุฑ ููุง] ููุชุจุฉ PostgreSQL
from decimal import Decimal, getcontext
from datetime import time
from zoneinfo import ZoneInfo

import ccxt.async_support as ccxt
from telegram import Update, ReplyKeyboardMarkup, ReplyKeyboardRemove, KeyboardButton
from telegram.ext import (
    Application,
    CommandHandler,
    ContextTypes,
    MessageHandler,
    filters,
    ConversationHandler,
)
from telegram.constants import ParseMode

# ุถุจุท ุฏูุฉ ุงูุฃุฑูุงู ุงูุนุดุฑูุฉ
getcontext().prec = 18

# --- ุฅุนุฏุงุฏุงุช ุงูุจูุช ุงูุฃุณุงุณูุฉ ---
TELEGRAM_BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN', 'YOUR_TELEGRAM_BOT_TOKEN')
# [ุชู ุงูุชุทููุฑ ููุง] ูุฑุงุกุฉ ุฑุงุจุท ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ
DATABASE_URL = os.getenv('DATABASE_URL')

# --- ุฅุนุฏุงุฏ ูุณุฌู ุงูุฃุญุฏุงุซ (Logger) ---
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logger = logging.getLogger(__name__)

# --- ุฅุนุฏุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช (PostgreSQL) ---
def get_db_connection():
    """ููุดุฆ ุงุชุตุงูุงู ุจูุงุนุฏุฉ ุจูุงูุงุช PostgreSQL."""
    try:
        conn = psycopg2.connect(DATABASE_URL)
        return conn
    except Exception as e:
        logger.error(f"ูุดู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช: {e}")
        return None

def init_database():
    """ุชูุดุฆ ุงูุฌุฏุงูู ุงููุงุฒูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ."""
    conn = get_db_connection()
    if not conn: return
    
    try:
        with conn.cursor() as cur:
            cur.execute('''
                CREATE TABLE IF NOT EXISTS portfolio (
                    id SERIAL PRIMARY KEY,
                    user_id BIGINT NOT NULL,
                    symbol TEXT NOT NULL,
                    exchange TEXT NOT NULL,
                    quantity TEXT NOT NULL,
                    avg_price TEXT NOT NULL,
                    UNIQUE(user_id, symbol, exchange)
                )
            ''')
        conn.commit()
        logger.info("ุชู ุชููุฆุฉ ุฌุฏุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ.")
    except Exception as e:
        logger.error(f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชููุฆุฉ ุงูุฌุฏุงูู: {e}")
    finally:
        if conn: conn.close()

# --- ุญุงูุงุช ุงููุญุงุฏุซุงุช ---
EXCHANGE, SYMBOL, QUANTITY, PRICE = range(4)
REMOVE_ID = range(4, 5)

# --- ูุชุบูุฑ ุนุงููู ูุชุฎุฒูู ูุงุฆูุงุช ุงูููุตุงุช ---
exchanges = {}

# --- ุฏูุงู ุจุฏุก ูุฅููุงู ุชุดุบูู ุงูุจูุช ---
async def post_init(application: Application):
    """ุงูููุงู ุงูุชู ูุชู ุชุดุบูููุง ุจุนุฏ ุจุฏุก ุงูุจูุช ูุจุงุดุฑุฉ."""
    global exchanges
    exchange_ids = ['binance', 'okx', 'kucoin', 'gateio', 'bybit', 'mexc']
    for ex_id in exchange_ids:
        try:
            exchange_class = getattr(ccxt, ex_id)
            exchanges[ex_id] = exchange_class({'enableRateLimit': True})
            logger.info(f"ุชู ุงูุงุชุตุงู ุจููุตุฉ {ex_id} ุจูุฌุงุญ.")
        except Exception as e:
            logger.error(f"ูุดู ุงูุงุชุตุงู ุจููุตุฉ {ex_id}: {e}")
            
    # [ุชู ุงูุชุทููุฑ ููุง] ุฌุฏููุฉ ุงูุชูุฑูุฑ ุงููููู
    cairo_tz = ZoneInfo("Africa/Cairo")
    # ุชูููุช ุงูุชูุฑูุฑ: 11:55 ูุณุงุกู ุจุชูููุช ุงููุงูุฑุฉ
    report_time = time(hour=23, minute=55, tzinfo=cairo_tz) 
    application.job_queue.run_daily(send_daily_report, time=report_time)
    logger.info(f"ุชู ุฌุฏููุฉ ุงูุชูุฑูุฑ ุงููููู ูู ุชูุงู ุงูุณุงุนุฉ {report_time.strftime('%H:%M')} ุจุชูููุช ุงููุงูุฑุฉ")


async def post_shutdown(application: Application):
    """ูุบูู ุฌููุน ุงุชุตุงูุงุช ุงูููุตุงุช ุนูุฏ ุฅููุงู ุงูุจูุช."""
    for ex_id, ex_instance in exchanges.items():
        try:
            await ex_instance.close()
            logger.info(f"ุชู ุฅุบูุงู ุงูุงุชุตุงู ุจููุตุฉ {ex_id}.")
        except Exception as e:
            logger.error(f"ุฎุทุฃ ุฃุซูุงุก ุฅุบูุงู ุงุชุตุงู {ex_id}: {e}")

# --- ููุญุฉ ุงูููุงุชูุญ ุงูุฑุฆูุณูุฉ ---
MAIN_KEYBOARD = [
    [KeyboardButton("๐ ุนุฑุถ ุงููุญูุธุฉ")],
    [KeyboardButton("โ ุฅุถุงูุฉ ุนููุฉ"), KeyboardButton("๐๏ธ ุญุฐู ุนููุฉ")],
    [KeyboardButton("โ๏ธ ุงูุฅุนุฏุงุฏุงุช"), KeyboardButton("โ ูุณุงุนุฏุฉ")],
]
MAIN_REPLY_MARKUP = ReplyKeyboardMarkup(MAIN_KEYBOARD, resize_keyboard=True)

# --- ุฏูุงู ูุณุงุนุฏุฉ ---
def format_price(price_decimal):
    if price_decimal == 0: return "$0.00"
    if price_decimal < Decimal('0.01'): return f"${price_decimal:,.8f}".rstrip('0').rstrip('.')
    return f"${price_decimal:,.4f}"
    
def format_quantity(quantity_decimal):
    return f"{quantity_decimal.normalize()}"

# --- ุฏูุงู ุงูุชุนุงูู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช (PostgreSQL) ---
def db_add_or_update_coin(user_id, symbol, exchange, quantity, price):
    conn = get_db_connection()
    if not conn: return
    try:
        with conn.cursor() as cur:
            cur.execute("SELECT quantity, avg_price FROM portfolio WHERE user_id = %s AND symbol = %s AND exchange = %s",
                        (user_id, symbol, exchange))
            result = cur.fetchone()

            quantity_dec = Decimal(str(quantity))
            price_dec = Decimal(str(price))

            if result:
                old_quantity = Decimal(result[0])
                old_avg_price = Decimal(result[1])
                total_quantity = old_quantity + quantity_dec
                new_avg_price = ((old_quantity * old_avg_price) + (quantity_dec * price_dec)) / total_quantity
                cur.execute("UPDATE portfolio SET quantity = %s, avg_price = %s WHERE user_id = %s AND symbol = %s AND exchange = %s",
                            (str(total_quantity), str(new_avg_price), user_id, symbol, exchange))
            else:
                cur.execute("INSERT INTO portfolio (user_id, symbol, exchange, quantity, avg_price) VALUES (%s, %s, %s, %s, %s)",
                            (user_id, symbol.upper(), exchange.lower(), str(quantity_dec), str(price_dec)))
        conn.commit()
    finally:
        conn.close()

def db_get_portfolio(user_id):
    conn = get_db_connection()
    if not conn: return []
    portfolio = []
    try:
        with conn.cursor() as cur:
            cur.execute("SELECT id, symbol, exchange, quantity, avg_price FROM portfolio WHERE user_id = %s ORDER BY symbol", (user_id,))
            rows = cur.fetchall()
            # ุชุญููู ุงููุชุงุฆุฌ ุฅูู ูุงููุณ
            for row in rows:
                portfolio.append({'id': row[0], 'symbol': row[1], 'exchange': row[2], 'quantity': row[3], 'avg_price': row[4]})
    finally:
        conn.close()
    return portfolio

def db_remove_coin(coin_id, user_id):
    conn = get_db_connection()
    if not conn: return False
    rows_deleted = 0
    try:
        with conn.cursor() as cur:
            cur.execute("DELETE FROM portfolio WHERE id = %s AND user_id = %s", (coin_id, user_id))
            rows_deleted = cur.rowcount
        conn.commit()
    finally:
        conn.close()
    return rows_deleted > 0

# --- ุงูุฃูุงูุฑ ุงูุฑุฆูุณูุฉ ููุนุงูุฌุงุช ุงูุฃุฒุฑุงุฑ ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user = update.effective_user
    welcome_message = f"ุฃููุงู ุจู ูุง {user.mention_html()} ูู ุจูุช ุชุชุจุน ุงููุญูุธุฉ!\n\nุงุฎุชุฑ ุฃุญุฏ ุงูุฎูุงุฑุงุช ูู ุงููุงุฆูุฉ ุจุงูุฃุณูู ููุจุฏุก."
    await update.message.reply_html(welcome_message, reply_markup=MAIN_REPLY_MARKUP)

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    help_text = "ุงุณุชุฎุฏู ุงูุฃุฒุฑุงุฑ ุจุงูุฃุณูู ูุฅุฏุงุฑุฉ ูุญูุธุชู."
    await update.message.reply_text(help_text, reply_markup=MAIN_REPLY_MARKUP)

async def settings_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    settings_text = "ููุง ุณุชุชููู ูุฑูุจุงู ูู ุถุจุท ุงูุชูุงุฑูุฑ ูุงูุชูุจููุงุช."
    await update.message.reply_text(settings_text, reply_markup=MAIN_REPLY_MARKUP)

# --- ูุญุงุฏุซุฉ ุฅุถุงูุฉ ุนููุฉ ---
async def add_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    reply_keyboard = [list(exchanges.keys())[i:i + 3] for i in range(0, len(exchanges.keys()), 3)]
    await update.message.reply_text(
        '**ุงูุฎุทูุฉ 1 ูู 4:** ุงุฎุชุฑ ููุตุฉ ุงูุดุฑุงุก.',
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True, resize_keyboard=True),
        parse_mode=ParseMode.MARKDOWN
    )
    return EXCHANGE

async def received_exchange(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    context.user_data['exchange'] = update.message.text.lower()
    await update.message.reply_text(
        "**ุงูุฎุทูุฉ 2 ูู 4:** ุฃุฏุฎู ุฑูุฒ ุงูุนููุฉ (ูุซุงู: `BTC`).",
        reply_markup=ReplyKeyboardRemove(), parse_mode=ParseMode.MARKDOWN
    )
    return SYMBOL

async def received_symbol(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    # [ุชู ุงูุชุทููุฑ ููุง] ุฅุถุงูุฉ /USDT ุชููุงุฆูุงู
    symbol = update.message.text.upper()
    if '/' not in symbol:
        symbol = f"{symbol}/USDT"
    
    context.user_data['symbol'] = symbol
    await update.message.reply_text(f"ุชู ุชุญุฏูุฏ: `{symbol}`\n\n**ุงูุฎุทูุฉ 3 ูู 4:** ูุง ูู ุงููููุฉุ", parse_mode=ParseMode.MARKDOWN)
    return QUANTITY
    
async def received_quantity(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        quantity = Decimal(update.message.text)
        if quantity <= 0: raise ValueError()
        context.user_data['quantity'] = quantity
        await update.message.reply_text(
            "**ุงูุฎุทูุฉ 4 ูู 4:** ูุง ูู ูุชูุณุท ุณุนุฑ ุงูุดุฑุงุก **ููุนููุฉ ุงููุงุญุฏุฉ**ุ", 
            parse_mode=ParseMode.MARKDOWN
        )
        return PRICE
    except Exception:
        await update.message.reply_text("ูููุฉ ุบูุฑ ุตุงูุญุฉ. ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงููููุฉ ูุฑูู ููุฌุจ.")
        return QUANTITY

async def received_price(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        price = Decimal(update.message.text)
        if price <= 0: raise ValueError()
        user_id = update.effective_user.id
        user_data = context.user_data
        db_add_or_update_coin(user_id, user_data['symbol'], user_data['exchange'], user_data['quantity'], price)
        await update.message.reply_text(f"โ **ุชูุช ุฅุถุงูุฉ/ุชุญุฏูุซ {user_data['symbol']} ุจูุฌุงุญ!**",
                                        reply_markup=MAIN_REPLY_MARKUP, parse_mode=ParseMode.MARKDOWN)
        user_data.clear()
        return ConversationHandler.END
    except Exception:
        await update.message.reply_text("ูููุฉ ุบูุฑ ุตุงูุญุฉ. ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงูุณุนุฑ ูุฑูู ููุฌุจ.")
        return PRICE

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    context.user_data.clear()
    await update.message.reply_text("ุชู ุฅูุบุงุก ุงูุนูููุฉ.", reply_markup=MAIN_REPLY_MARKUP)
    return ConversationHandler.END

# --- ูุญุงุฏุซุฉ ุญุฐู ุนููุฉ ---
async def remove_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await update.message.reply_text("ูุญุฐู ุนูููุฉุ ุฃุฑุณู ุฑูู ุงูู ID ุงูุฎุงุต ุจูุง.", reply_markup=ReplyKeyboardRemove())
    return REMOVE_ID

async def received_remove_id(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    user_id = update.effective_user.id
    try:
        coin_id_to_remove = int(update.message.text)
        if db_remove_coin(coin_id_to_remove, user_id):
            await update.message.reply_text(f"โ ุชู ุญุฐู ุงูุนูููุฉ ุฑูู `{coin_id_to_remove}` ุจูุฌุงุญ.", reply_markup=MAIN_REPLY_MARKUP)
        else:
            await update.message.reply_text(f"ูู ูุชู ุงูุนุซูุฑ ุนูู ุนูููุฉ ุจุงูุฑูู `{coin_id_to_remove}`.", reply_markup=MAIN_REPLY_MARKUP)
    except ValueError:
        await update.message.reply_text("ุฅุฏุฎุงู ุบูุฑ ุตุงูุญ. ุฃุฑุณู ุฑูู ููุท.", reply_markup=MAIN_REPLY_MARKUP)
    return ConversationHandler.END

# --- ูุธุงุฆู ุฌูุจ ุงูุฃุณุนุงุฑ ูุนุฑุถ ุงููุญูุธุฉ ---
async def fetch_price(exchange_id, symbol):
    exchange = exchanges.get(exchange_id)
    if not exchange: return None, "ุงูููุตุฉ ุบูุฑ ูููุฆุฉ"
    
    symbols_to_try = [symbol, symbol.replace('/', '-'), symbol.replace('/', '')]
    for s in symbols_to_try:
        try:
            ticker = await exchange.fetch_ticker(s)
            if ticker and ticker.get('last'): return ticker['last'], None
        except Exception: continue
            
    logger.warning(f"ูุดู ุฌูุจ ุณุนุฑ {symbol} ูู {exchange_id} ุจูู ุงูุตูุบ.")
    return None, "ุฑูุฒ ุบูุฑ ุตุญูุญ"

async def generate_portfolio_report(user_id: int) -> str:
    """
    ุชูุดุฆ ูุต ุชูุฑูุฑ ุงููุญูุธุฉ ููุณุชุฎุฏู ูุนูู.
    ูุฐู ุงูุฏุงูุฉ ููุตููุฉ ูุฅุนุงุฏุฉ ุงุณุชุฎุฏุงููุง ูู ุงูุชูุงุฑูุฑ ุงูููููุฉ.
    """
    portfolio = db_get_portfolio(user_id)
    if not portfolio:
        return "ูุญูุธุชู ูุงุฑุบุฉ ุญุงููุงู."

    tasks = [fetch_price(item['exchange'], item['symbol']) for item in portfolio]
    results = await asyncio.gather(*tasks)

    total_portfolio_value = Decimal('0.0')
    total_investment_cost = Decimal('0.0')
    report_lines = []
    
    for i, item in enumerate(portfolio):
        quantity = Decimal(item['quantity'])
        avg_price = Decimal(item['avg_price'])
        investment_cost = quantity * avg_price
        total_investment_cost += investment_cost
        
        current_price, error_msg = results[i]
        current_value = investment_cost # ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ ุฅุฐุง ูุดู ุฌูุจ ุงูุณุนุฑ
        if current_price:
            current_value = quantity * Decimal(str(current_price))
        total_portfolio_value += current_value

    # [ุชู ุงูุชุทููุฑ ููุง] ูุถุน ุงูููุฎุต ูู ุจุฏุงูุฉ ุงูุชูุฑูุฑ
    total_pnl = total_portfolio_value - total_investment_cost
    total_pnl_percent = (total_pnl / total_investment_cost * 100) if total_investment_cost > 0 else 0
    total_pnl_icon = "๐ข" if total_pnl >= 0 else "๐ด"
    
    summary = (
        f"**๐ ููุฎุต ุงููุญูุธุฉ**\n\n"
        f"โช๏ธ **ุฑุฃุณ ุงููุงู:** `${total_investment_cost:,.2f}`\n"
        f"โช๏ธ **ุงููููุฉ ุงูุญุงููุฉ:** `${total_portfolio_value:,.2f}`\n"
        f"{total_pnl_icon} **ุฅุฌูุงูู ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ:**\n"
        f"`${total_pnl:+.2f} ({total_pnl_percent:+.2f}%)`\n\n"
        f"--- **ุงูุชูุงุตูู** ---\n"
    )
    report_lines.append(summary)

    for i, item in enumerate(portfolio):
        current_price, error_msg = results[i]
        quantity = Decimal(item['quantity'])
        avg_price = Decimal(item['avg_price'])
        investment_cost = quantity * avg_price
        
        line = (
            f"๐ `{item['id']}` | **{item['symbol']}** | `{item['exchange'].capitalize()}`\n"
            f"ุงููููุฉ: `{format_quantity(quantity)}`\n"
            f"ูุชูุณุท ุงูุดุฑุงุก: `{format_price(avg_price)}`"
        )
        
        if current_price:
            current_price_dec = Decimal(str(current_price))
            current_value = quantity * current_price_dec
            pnl = current_value - investment_cost
            pnl_percent = (pnl / investment_cost * 100) if investment_cost > 0 else 0
            pnl_icon = "๐" if pnl >= 0 else "๐"
            line += (
                f"\nุงูุณุนุฑ ุงูุญุงูู: `{format_price(current_price_dec)}`\n"
                f"ุงููููุฉ ุงูุญุงููุฉ: `${current_value:,.2f}`\n"
                f"{pnl_icon} ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ: `${pnl:+.2f} ({pnl_percent:+.2f}%)`"
            )
        else:
            line += f"\nุงูุณุนุฑ ุงูุญุงูู: `ุบูุฑ ูุชุงุญ ({error_msg})`"

        report_lines.append(line)
        report_lines.append("---")
        
    return "\n".join(report_lines)

async def portfolio_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    msg = await update.message.reply_text("โณ ุฌุงุฑู ุฅุนุฏุงุฏ ุงูุชูุฑูุฑ...")
    report_text = await generate_portfolio_report(user_id)
    await msg.edit_text(report_text, parse_mode=ParseMode.MARKDOWN)

# [ุชู ุงูุชุทููุฑ ููุง] ุฏุงูุฉ ุงูุชูุฑูุฑ ุงููููู
async def send_daily_report(context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    ูุฑุณู ุชูุฑูุฑ ุงููุญูุธุฉ ุงููููู ูุฌููุน ุงููุณุชุฎุฏููู ุงูุฐูู ูุฏููู ุนููุงุช.
    """
    conn = get_db_connection()
    if not conn: return
    try:
        with conn.cursor() as cur:
            # ุฌูุจ ุฌููุน ูุนุฑูุงุช ุงููุณุชุฎุฏููู ุงููุฑูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
            cur.execute("SELECT DISTINCT user_id FROM portfolio")
            user_ids = [row[0] for row in cur.fetchall()]
    finally:
        conn.close()
        
    for user_id in user_ids:
        try:
            report_text = await generate_portfolio_report(user_id)
            # ุฅุถุงูุฉ ุนููุงู ููุชูุฑูุฑ ุงููููู
            final_report = f"**๐๏ธ ุชูุฑูุฑู ุงููููู ูููุญูุธุฉ**\n\n{report_text}"
            await context.bot.send_message(chat_id=user_id, text=final_report, parse_mode=ParseMode.MARKDOWN)
            await asyncio.sleep(1) # ูุชุฌูุจ ุฅุบุฑุงู ุณูุฑูุฑุงุช ุชููุฌุฑุงู ุจุงูุทูุจุงุช
        except Exception as e:
            logger.error(f"ูุดู ุฅุฑุณุงู ุงูุชูุฑูุฑ ุงููููู ูููุณุชุฎุฏู {user_id}: {e}")


def main() -> None:
    if not TELEGRAM_BOT_TOKEN or TELEGRAM_BOT_TOKEN == 'YOUR_TELEGRAM_BOT_TOKEN':
        logger.critical("FATAL ERROR: ูู ูุชู ุชุนููู ุชููู ุงูุชููุฌุฑุงู.")
        return
    if not DATABASE_URL:
        logger.critical("FATAL ERROR: ูู ูุชู ุชุนููู ุฑุงุจุท ูุงุนุฏุฉ ุงูุจูุงูุงุช (DATABASE_URL).")
        return

    init_database()
    application = Application.builder().token(TELEGRAM_BOT_TOKEN).post_init(post_init).post_shutdown(post_shutdown).build()

    conv_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex("^โ ุฅุถุงูุฉ ุนููุฉ$"), add_start)],
        states={
            EXCHANGE: [MessageHandler(filters.TEXT & ~filters.COMMAND, received_exchange)],
            SYMBOL: [MessageHandler(filters.TEXT & ~filters.COMMAND, received_symbol)],
            QUANTITY: [MessageHandler(filters.TEXT & ~filters.COMMAND, received_quantity)],
            PRICE: [MessageHandler(filters.TEXT & ~filters.COMMAND, received_price)],
        }, fallbacks=[CommandHandler("cancel", cancel)])

    remove_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex("^๐๏ธ ุญุฐู ุนููุฉ$"), remove_start)],
        states={REMOVE_ID: [MessageHandler(filters.TEXT & ~filters.COMMAND, received_remove_id)]},
        fallbacks=[CommandHandler("cancel", cancel)])

    application.add_handler(CommandHandler("start", start))
    application.add_handler(conv_handler)
    application.add_handler(remove_handler)
    application.add_handler(MessageHandler(filters.Regex("^๐ ุนุฑุถ ุงููุญูุธุฉ$"), portfolio_command))
    application.add_handler(MessageHandler(filters.Regex("^โ๏ธ ุงูุฅุนุฏุงุฏุงุช$"), settings_command))
    application.add_handler(MessageHandler(filters.Regex("^โ ูุณุงุนุฏุฉ$"), help_command))

    logger.info("... ุงูุจูุช ููุฏ ุงูุชุดุบูู ...")
    application.run_polling(drop_pending_updates=True)

if __name__ == "__main__":
    main()


